import { __assign, __awaiter, __generator } from "tslib";
import { getEndpointFromInstructions } from "@aws-sdk/middleware-endpoint";
import { HttpRequest } from "@aws-sdk/protocol-http";
import { formatUrl } from "@aws-sdk/util-format-url";
import { S3RequestPresigner } from "./presigner";
export var getSignedUrl = function (client, command, options) {
    if (options === void 0) { options = {}; }
    return __awaiter(void 0, void 0, void 0, function () {
        var s3Presigner, endpointV2, authScheme_1, presignInterceptMiddleware, middlewareName, clientStack, handler, output, presigned;
        var _a, _b;
        return __generator(this, function (_c) {
            switch (_c.label) {
                case 0:
                    if (!(typeof client.config.endpointProvider === "function")) return [3, 2];
                    return [4, getEndpointFromInstructions(command.input, command.constructor, client.config)];
                case 1:
                    endpointV2 = _c.sent();
                    authScheme_1 = (_b = (_a = endpointV2.properties) === null || _a === void 0 ? void 0 : _a.authSchemes) === null || _b === void 0 ? void 0 : _b[0];
                    s3Presigner = new S3RequestPresigner(__assign(__assign({}, client.config), { signingName: authScheme_1 === null || authScheme_1 === void 0 ? void 0 : authScheme_1.signingName, region: function () { return __awaiter(void 0, void 0, void 0, function () { return __generator(this, function (_a) {
                            return [2, authScheme_1 === null || authScheme_1 === void 0 ? void 0 : authScheme_1.signingScope];
                        }); }); } }));
                    return [3, 3];
                case 2:
                    s3Presigner = new S3RequestPresigner(client.config);
                    _c.label = 3;
                case 3:
                    presignInterceptMiddleware = function (next, context) { return function (args) { return __awaiter(void 0, void 0, void 0, function () {
                        var request, presigned;
                        var _a, _b;
                        return __generator(this, function (_c) {
                            switch (_c.label) {
                                case 0:
                                    request = args.request;
                                    if (!HttpRequest.isInstance(request)) {
                                        throw new Error("Request to be presigned is not an valid HTTP request.");
                                    }
                                    delete request.headers["amz-sdk-invocation-id"];
                                    delete request.headers["amz-sdk-request"];
                                    delete request.headers["x-amz-user-agent"];
                                    return [4, s3Presigner.presign(request, __assign(__assign({}, options), { signingRegion: (_a = options.signingRegion) !== null && _a !== void 0 ? _a : context["signing_region"], signingService: (_b = options.signingService) !== null && _b !== void 0 ? _b : context["signing_service"] }))];
                                case 1:
                                    presigned = _c.sent();
                                    return [2, {
                                            response: {},
                                            output: {
                                                $metadata: { httpStatusCode: 200 },
                                                presigned: presigned,
                                            },
                                        }];
                            }
                        });
                    }); }; };
                    middlewareName = "presignInterceptMiddleware";
                    clientStack = client.middlewareStack.clone();
                    clientStack.addRelativeTo(presignInterceptMiddleware, {
                        name: middlewareName,
                        relation: "before",
                        toMiddleware: "awsAuthMiddleware",
                        override: true,
                    });
                    handler = command.resolveMiddleware(clientStack, client.config, {});
                    return [4, handler({ input: command.input })];
                case 4:
                    output = (_c.sent()).output;
                    presigned = output.presigned;
                    return [2, formatUrl(presigned)];
            }
        });
    });
};
